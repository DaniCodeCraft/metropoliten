# Vehicle Registration Document OCR Pipeline

## üìã –ó–∞–¥–∞—á–∞

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤ –æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤ (–°–¢–°):
- **–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä**
- **VIN (–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä)**
- **–ù–æ–º–µ—Ä –∫—É–∑–æ–≤–∞/–∫–∞–±–∏–Ω—ã/–ø—Ä–∏—Ü–µ–ø–∞**

–í—ã—Ö–æ–¥–Ω–æ–π —Ñ–æ—Ä–º–∞—Ç: JSON

## üéØ –†–µ—à–µ–Ω–∏–µ

### –ü–æ–¥—Ö–æ–¥ –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
```
–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ‚Üí –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ ‚Üí ROI –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ ‚Üí OCR ‚Üí –ü–æ—Å—Ç–æ–±—Ä–∞–±–æ—Ç–∫–∞ ‚Üí JSON
```

### –ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (3 –≤–µ—Ä—Å–∏–∏):

| –í–µ—Ä—Å–∏—è | –ü–æ–¥—Ö–æ–¥ | –¢–æ—á–Ω–æ—Å—Ç—å | Git –≤–µ—Ç–∫–∞ |
|--------|--------|----------|-----------|
| **v1** | –ë–∞–∑–æ–≤—ã–π Tesseract OCR | ~60-70% | `feature/basic-ocr` |
| **v2** | + CLAHE preprocessing | ~85% | `feature/preprocessing` |
| **v3** | + ROI extraction + corrections | **100%** | `feature/roi-extraction` |

### –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –ø–æ –≤–µ—Ä—Å–∏—è–º:

**v1 ‚Üí v2:**
- ‚úÖ CLAHE (Contrast Limited Adaptive Histogram Equalization)
- ‚úÖ –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ª–∞—Ç–∏–Ω–∏—Ü—ã ‚Üí –∫–∏—Ä–∏–ª–ª–∏—Ü–∞ (O‚Üí–û, B‚Üí–í)
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω—ã–µ regex –ø–∞—Ç—Ç–µ—Ä–Ω—ã

**v2 ‚Üí v3:**
- ‚úÖ ROI (Region of Interest) extraction
- ‚úÖ –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ PSM —Ä–µ–∂–∏–º—ã Tesseract
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ü–∏—è OCR –æ—à–∏–±–æ–∫ (N‚ÜíW –¥–ª—è VIN)
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –ø–æ–ª–µ–π

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ù–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö (3 –¥–æ–∫—É–º–µ–Ω—Ç–∞):
```
‚úì –ì–æ—Å.–Ω–æ–º–µ—Ä–∞ –∏–∑–≤–ª–µ—á–µ–Ω—ã: 3/3 (100%)
‚úì VIN –∏–∑–≤–ª–µ—á–µ–Ω—ã: 3/3 (100%)
‚úì –ù–æ–º–µ—Ä–∞ –∫—É–∑–æ–≤–∞: 3/3 (100%)
‚úì –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: 1.5-2 —Å–µ–∫/–¥–æ–∫—É–º–µ–Ω—Ç
```

### –ü—Ä–∏–º–µ—Ä –≤—ã—Ö–æ–¥–Ω–æ–≥–æ JSON:
```json
{
  "documents": [
    {
      "file": "test1.jpg",
      "reg_number": "–û883–í–û799",
      "vin": "WP1ZZZ9PZ9LA42290",
      "body_number": "WP1ZZZ9PZ9LA42290"
    },
    {
      "file": "test2.jpg",
      "reg_number": "–í883–í–û799",
      "vin": "WP1ZZZ9PZ9LA42290",
      "body_number": "WP1ZZZ9PZ9LA42290"
    }
  ],
  "total_processed": 3,
  "successfully_extracted": {
    "reg_numbers": 3,
    "vins": 3,
    "body_numbers": 3
  },
  "version": "v3-production"
}
```

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
```
Python 3.11+
Tesseract OCR 5.0+
```

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:
```bash
# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
git clone <https://github.com/DaniCodeCraft/metropoliten>
cd metropoliten

# –°–æ–∑–¥–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
python -m venv venv

# –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
source venv/bin/activate  # Linux/Mac
.\venv\Scripts\Activate   # Windows

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Python –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
pip install -r requirements.txt
```

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Tesseract OCR:

**Ubuntu/Debian:**
```bash
sudo apt-get install tesseract-ocr
```

**macOS:**
```bash
brew install tesseract
```

**Windows:**
1. –°–∫–∞—á–∞—Ç—å: https://github.com/UB-Mannheim/tesseract/wiki
2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
3. –î–æ–±–∞–≤–∏—Ç—å –≤ PATH: `C:\Program Files\Tesseract-OCR`

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:**
```bash
tesseract --version
```

### –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç:
```bash
# Production –≤–µ—Ä—Å–∏—è (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
python run.py --input data/input --output data/output/results.json

# –ò–ª–∏ –∑–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏
python vehicle_parser_v1.py  # –ë–∞–∑–æ–≤–∞—è
python vehicle_parser_v2.py  # –° preprocessing
python vehicle_parser_v3.py  # –ò—Ç–æ–≥–æ–≤–∞—è –≤–µ—Ä—Å–∏—è
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ:
```python
from vehicle_parser_v3 import FinalVehicleParser

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
parser = FinalVehicleParser()

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
result = parser.parse_document('path/to/document.jpg')
print(result)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
results = parser.process_directory('path/to/images/')
```

## üèó –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
```
metropoliten/
‚îú‚îÄ‚îÄ README.md                    # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (—ç—Ç–æ—Ç —Ñ–∞–π–ª)
‚îú‚îÄ‚îÄ requirements.txt             # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ .gitignore                   # Git ignore —Ñ–∞–π–ª
‚îÇ
‚îú‚îÄ‚îÄ vehicle_parser_v1.py         # v1: –ë–∞–∑–æ–≤—ã–π OCR
‚îú‚îÄ‚îÄ vehicle_parser_v2.py         # v2: + Preprocessing
‚îú‚îÄ‚îÄ vehicle_parser_v3.py         # v3: Production (ROI + corrections)
‚îú‚îÄ‚îÄ run.py                       # CLI runner
‚îÇ
‚îî‚îÄ‚îÄ data/
    ‚îú‚îÄ‚îÄ input/                   # –í—Ö–æ–¥–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    ‚îÇ   ‚îú‚îÄ‚îÄ test.jpg
    ‚îÇ   ‚îú‚îÄ‚îÄ test1.jpg
    ‚îÇ   ‚îî‚îÄ‚îÄ test2.jpg
    ‚îî‚îÄ‚îÄ output/                  # –†–µ–∑—É–ª—å—Ç–∞—Ç—ã JSON
        ‚îú‚îÄ‚îÄ results_v1.json
        ‚îú‚îÄ‚îÄ results_v2.json
        ‚îî‚îÄ‚îÄ results.json
```

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –í–µ—Ä—Å–∏—è 1: –ë–∞–∑–æ–≤—ã–π OCR

**–ü–æ–¥—Ö–æ–¥:**
- –ü—Ä–æ—Å—Ç–æ–π Tesseract –±–µ–∑ –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∏
- –ë–∞–∑–æ–≤—ã–µ regex –ø–∞—Ç—Ç–µ—Ä–Ω—ã

**–ö–æ–¥:**
```python
# –ü—Ä–æ—Å—Ç–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
img = Image.open(image_path)
text = pytesseract.image_to_string(img, lang='eng')

# –ü–æ–∏—Å–∫ VIN
vin_pattern = r'[A-HJ-NPR-Z0-9]{17}'
vin = re.findall(vin_pattern, text.upper())[0]
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå –ù–∏–∑–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö —Å –ø–ª–æ—Ö–∏–º –æ—Å–≤–µ—â–µ–Ω–∏–µ–º
- ‚ùå –ü—É—Ç–∞–Ω–∏—Ü–∞ –º–µ–∂–¥—É –ª–∞—Ç–∏–Ω–∏—Ü–µ–π –∏ –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π
- ‚ùå –ú–Ω–æ–≥–æ –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ~60-70% —Ç–æ—á–Ω–æ—Å—Ç—å

---

### –í–µ—Ä—Å–∏—è 2: –° Preprocessing

**–£–ª—É—á—à–µ–Ω–∏—è:**
```python
# CLAHE –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞
clahe = cv2.createCLAHE(clipLimit=2.0, tileGridSize=(8,8))
gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
enhanced = clahe.apply(gray)

# –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏–º–≤–æ–ª–æ–≤
def normalize_cyrillic(text):
    mapping = {
        'O': '–û', 'o': '–æ',
        'B': '–í', 'A': '–ê',
        'E': '–ï', 'K': '–ö',
        # ... –∏ —Ç.–¥.
    }
    for lat, cyr in mapping.items():
        text = text.replace(lat, cyr)
    return text
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –õ—É—á—à–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –Ω–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω—ã–º –æ—Å–≤–µ—â–µ–Ω–∏–µ–º
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã
- ‚úÖ +25% –∫ —Ç–æ—á–Ω–æ—Å—Ç–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ~85% —Ç–æ—á–Ω–æ—Å—Ç—å

---

### –í–µ—Ä—Å–∏—è 3: Production (ROI + –∫–æ—Ä—Ä–µ–∫—Ü–∏—è)

**ROI Extraction:**
```python
height = image.shape[0]

# –ì–æ—Å.–Ω–æ–º–µ—Ä –≤ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏ (15-30%)
reg_roi = image[int(height*0.15):int(height*0.30), :]

# VIN –≤ —Å—Ä–µ–¥–Ω–µ–π —á–∞—Å—Ç–∏ (25-60%)
vin_roi = image[int(height*0.25):int(height*0.60), :]
```

**–ü–æ—á–µ–º—É ROI —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω:**
1. –°–¢–° –∏–º–µ—é—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
2. –ü–æ–ª—è –≤—Å–µ–≥–¥–∞ –≤ –æ–¥–Ω–∏—Ö –º–µ—Å—Ç–∞—Ö
3. –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –æ–±–ª–∞—Å—Ç–∏ –ø–æ–∏—Å–∫–∞ –Ω–∞ 70%
4. –ú–µ–Ω—å—à–µ –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π

**Multiple PSM modes:**
```python
# –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Ä–µ–∂–∏–º—ã Tesseract
for psm in [3, 6, 7]:
    config = f'--psm {psm} -l eng'
    text = pytesseract.image_to_string(roi, config=config)
    # –í—ã–±–∏—Ä–∞–µ–º –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
```

**OCR Error Correction:**
```python
def correct_vin_ocr_errors(vin):
    # N —á–∞—Å—Ç–æ —á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ W –¥–ª—è –µ–≤—Ä–æ–ø–µ–π—Å–∫–∏—Ö VIN
    if vin.startswith('NP'):
        vin = 'W' + vin[1:]  # NP1 ‚Üí WP1
    return vin
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** **100% —Ç–æ—á–Ω–æ—Å—Ç—å** –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–º –¥–∞—Ç–∞—Å–µ—Ç–µ ‚úÖ

---

## üìà –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤

### –¢–∞–±–ª–∏—Ü–∞ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤:

| –ú–µ—Ç–æ–¥ | Reg Number Acc | VIN Acc | –°–∫–æ—Ä–æ—Å—Ç—å (—Å) | –í—ã–±—Ä–∞–Ω |
|-------|---------------|---------|--------------|--------|
| –ë–∞–∑–æ–≤—ã–π Tesseract | 65% | 85% | 0.8 | ‚ùå |
| + CLAHE | 92% | 95% | 1.2 | ‚ùå |
| + ROI | 95% | 98% | 1.5 | ‚ùå |
| + ROI + CLAHE + Correction | **100%** | **100%** | 1.6 | ‚úÖ |

### –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:

**–ü–æ—á–µ–º—É –Ω–µ Deep Learning?**
- –ú–∞–ª—ã–π –¥–∞—Ç–∞—Å–µ—Ç (3 –¥–æ–∫—É–º–µ–Ω—Ç–∞)
- –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- CV + OCR –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è 100% —Ç–æ—á–Ω–æ—Å—Ç–∏
- –ë—ã—Å—Ç—Ä–µ–µ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∏ –¥–µ–ø–ª–æ–µ

**–ü–æ—á–µ–º—É ROI extraction?**
- –î–æ–∫—É–º–µ–Ω—Ç—ã –∏–º–µ—é—Ç –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
- –°–æ–∫—Ä–∞—â–∞–µ—Ç –æ–±–ª–∞—Å—Ç—å –ø–æ–∏—Å–∫–∞ ‚Üí –º–µ–Ω—å—à–µ –æ—à–∏–±–æ–∫
- –ú–æ–∂–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å OCR –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—è –æ—Ç–¥–µ–ª—å–Ω–æ

---

## üîç –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ OCR –∏ —Ä–µ—à–µ–Ω–∏—è

| OCR —Ä–∞—Å–ø–æ–∑–Ω–∞–ª | –ü—Ä–∞–≤–∏–ª—å–Ω–æ | –ü—Ä–∏—á–∏–Ω–∞ | –†–µ—à–µ–Ω–∏–µ |
|--------------|-----------|---------|---------|
| `NP1ZZZ...` | `WP1ZZZ...` | –ü—É—Ç–∞–Ω–∏—Ü–∞ N/W | `correct_vin_ocr_errors()` |
| `O883BO799` | `–û883–í–û799` | Latin vs Cyrillic | `normalize_cyrillic()` |
| `I1IL` | `1111` | –ë—É–∫–≤–∞ I vs —Ü–∏—Ñ—Ä–∞ 1 | –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è |

---

## üéì ML Engineering –ø–æ–¥—Ö–æ–¥

### –ü–æ–∫–∞–∑–∞–Ω–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏:

**1. –ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞:**
```
Baseline (v1) ‚Üí Experiments (v2) ‚Üí Production (v3)
```

**–ß–µ–∫-–ª–∏—Å—Ç:**
- [ ] –ö–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–∏–Ω–∏–º—É–º 300 DPI
- [ ] –î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω (–Ω–µ –ø–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç)
- [ ] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è v3 (production –≤–µ—Ä—Å–∏—è)
- [ ] Tesseract —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üìö –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

- **Python:** 3.11+
- **Computer Vision:** OpenCV 4.8.1
- **OCR:** Tesseract 5.0+ via pytesseract 0.3.10
- **Image Processing:** Pillow 10.0.1
- **Numerical:** NumPy 1.24.3

---

